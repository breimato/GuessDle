{% extends "base.html" %}
{% load static game_extras %}

{% block title %}{{ game.name }}{% endblock %}

{% block main_class %}
min-h-screen flex flex-col items-center gap-10 py-10 px-4
bg-no-repeat bg-cover bg-fixed
{% endblock %}

{% block content %}

{# ——— Audio reto ——— #}
{% if is_challenge %}
<script>
  const IS_CHALLENGE          = "{{ is_challenge_js }}";           // "true"
  const CHALLENGE_REPORT_URL  = "{{ challenge_report_url }}";
  const CSRF_TOKEN            = "{{ csrf_token }}";
</script>
  {% if game.audio_file %}
  <audio autoplay loop>
    <source src="{{ game.audio_file.url }}" type="audio/mpeg">
  </audio>
  {% endif %}
  <div class="epic-aura"></div>
{% endif %}

{# ——— Botón dashboard ——— #}
<div class="mb-4">
  <a href="{% url 'dashboard' %}"
     class="bg-yellow-700 hover:bg-yellow-800 text-white font-semibold px-4 py-2 rounded-full shadow transition">
    🏠 Dashboard
  </a>
</div>

{# ——— Título ——— #}
<section class="container mx-auto text-center drop-shadow">
  <h1 class="text-5xl md:text-6xl font-bold text-yellow-300 tracking-wide"
      style="font-family:var(--font-lol); text-shadow:2px 2px #000;">
    🛡️ {{ game.name }}
  </h1>
</section>

{# ——— Flag de victoria (para JS) ——— #}
{% if won %}
  <script id="won-flag" data-champ="{{ target.name|escapejs }}"></script>
{% endif %}

{# ——— Formulario siempre presente, pero desactivado si won ——— #}
<form id="guess-form"
      action="{{ guess_url }}"
      method="post"
      class="bg-amber-100/90 backdrop-blur rounded-3xl p-6 border-4 border-yellow-800 shadow-lg w-full max-w-xl text-gray-900
             {% if won %}opacity-50 pointer-events-none{% endif %}"
      novalidate>

  {% csrf_token %}
  <label for="guess" class="block font-semibold mb-2">¿Quién crees que es?</label>

  {% if guess_error %}
    <p class="text-red-700 font-bold mb-2">Ese personaje no existe o ya fue usado.</p>
  {% endif %}

  <div class="relative">
    <input  type="text" name="guess" id="guess" autofocus
            class="w-full p-2 rounded-t border border-yellow-400 bg-white focus:outline-none"
            placeholder="Escribe un nombre"
            autocomplete="off"
            required
            data-names="{{ remaining_names_json|escape }}"
            {% if won %}disabled{% endif %}>
    <ul id="suggestions" role="listbox"
        class="hidden w-full absolute left-0 top-full bg-white text-gray-900 rounded-b-xl
               border-x border-b border-yellow-400 max-h-56 overflow-y-auto z-50"></ul>
  </div>

  <button type="submit"
          class="mt-4 bg-yellow-700 hover:bg-yellow-800 text-white px-4 py-2 rounded-full transition w-full shadow"
          {% if won %}disabled{% endif %}>
    Probar
  </button>
</form>

{# ---------- Cabecera de atributos ---------- #}
{% if game.attributes %}
  {# ——— CABECERA + INTENTOS CON SCROLL LATERAL ——— #}
<div class="attempts-scroll-wrapper">
  <div id="attempts-header"
       {% if attempts %}class="header-grid"{% else %}class="header-grid" style="display:none;"{% endif %}
       data-cols="{{ game.attributes|length|add:'1' }}">
    <div class="header-cell">Personaje</div>
    {% for attr in game.attributes %}
      <div class="header-cell">{{ attr|title }}</div>
    {% endfor %}
  </div>

  <div id="attempts-container"></div>
</div>

{# ——— HISTORIAL JSON ——— #}
{% if attempts %}
  {{ attempts|json_script:"initial-attempts" }}
{% endif %}
{% endif %}


{# ——— Personaje de ayer ——— #}
{% if yesterday_target_name %}
  <div class="mt-6 mx-auto max-w-xl bg-black/60 text-white border-2 border-yellow-600 rounded-xl px-4 py-3 shadow-lg backdrop-blur">
    <p class="text-lg text-yellow-200 font-semibold text-center"
       style="font-family: var(--font-lol); text-shadow: 1px 1px #000;">
      🕐 El personaje de ayer fue: <span class="text-white">{{ yesterday_target_name }}</span>
    </p>
  </div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
  <script src="{% static 'js/guess-autocomplete.js' %}" defer></script>
  <script src="{% static 'js/attempts-live.js' %}" defer></script>


{% if is_challenge %}
<form id="challenge-report-form" method="POST" action="{% url 'play_challenge' challenge_id %}">
  {% csrf_token %}
  <input type="hidden" name="attempts" id="challenge-attempts-input">
</form>

<script>
  function reportChallengeResult(attempts) {
    const input = document.getElementById("challenge-attempts-input");
    input.value = attempts;
    document.getElementById("challenge-report-form").submit();
  }

  // Hook automático si ganaste
  const wonFlag = document.getElementById("won-flag");
  if (wonFlag) {
    // Contar los intentos jugados
    const attempts = document.querySelectorAll("#attempts-container > *").length;
    reportChallengeResult(attempts);
  }
</script>
{% endif %}

{% endblock %}

<style>
  @import "https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css";
  .square{ @apply rounded-xl flex items-center justify-center border-2 h-14 md:h-16 font-semibold text-sm text-center;}
  .square-good { @apply bg-green-600 text-white border-green-800;}
  .square-part { @apply bg-yellow-400 text-black border-yellow-600;}
  .square-bad  { @apply bg-red-700   text-white border-red-800;}
  .square-content{ @apply w-full h-full flex items-center justify-center p-1;}
  .champion-icon-name{ @apply text-xs mt-1;}
</style>

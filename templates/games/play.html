{% extends "base.html" %}
{% load static game_extras %}

{% block title %}{{ game.name }}{% endblock %}

{% block main_class %}
min-h-screen flex flex-col items-center gap-10 py-10 px-4
bg-no-repeat bg-cover bg-fixed
{% endblock %}

{% block content %}

{# â€”â€”â€” Audio reto â€”â€”â€” #}
{% if is_challenge %}
<script>
  const IS_CHALLENGE          = "{{ is_challenge_js }}";
  const CHALLENGE_REPORT_URL  = "{{ challenge_report_url }}";
  const CSRF_TOKEN            = "{{ csrf_token }}";
</script>
  {% if game.audio_file %}
  <audio autoplay loop>
    <source src="{{ game.audio_file.url }}" type="audio/mpeg">
  </audio>
  {% endif %}
  <div class="epic-aura"></div>
{% endif %}

{# â€”â€”â€” BotÃ³n dashboard â€”â€”â€” #}
<div class="mb-4">
  <a href="{% url 'dashboard' %}"
     class="bg-yellow-700 hover:bg-yellow-800 text-white font-semibold px-4 py-2 rounded-full shadow transition">
    ğŸ  Dashboard
  </a>
</div>


<div id="game-data"
     data-slug="{{ game.slug }}"
     {% if extra_play %}
     data-extra-id="{{ extra_play.id }}"
     {% endif %}
     data-max-extras-reached="{{ max_extras_reached|yesno:'true,false' }}">

</div>


{% if show_mode_switcher %}
  <div class="flex gap-2 justify-center mb-4">
    {% for m in available_modes %}
      <a href="?mode={{ m.slug }}"
         class="px-4 py-2 rounded-full font-semibold shadow transition
         {% if mode.slug == m.slug %}bg-yellow-700 text-white{% else %}bg-gray-200 hover:bg-yellow-100 text-yellow-900{% endif %}">
        {{ m.name|default:m.slug|capfirst }}
      </a>
    {% endfor %}
  </div>
{% endif %}


{# â€”â€”â€” EMOJI HINTS (solo modo emoji) â€”â€”â€” #}
{% if mode.slug == "emoji" and emoji_hint %}
  <div id="emoji-hints" class="flex justify-center gap-3 mb-4 text-3xl">
    {% for emoji in emoji_hint %}
      <span>{{ emoji }}</span>
    {% endfor %}
  </div>
{% endif %}



{# â€”â€”â€” TÃ­tulo â€”â€”â€” #}
<section class="container mx-auto text-center drop-shadow">
  <h1 class="text-5xl md:text-6xl font-bold text-yellow-300 tracking-wide"
      style="font-family:var(--font-lol); text-shadow:2px 2px #000;">
    ğŸ›¡ï¸ {{ game.name }}
  </h1>
</section>


{% if mode.slug == "emoji" and emoji_hint %}
  <div class="flex justify-center gap-4 my-6">
    {% for e in emoji_hint %}
      <span class="text-5xl select-none">{{ e }}</span>
    {% endfor %}
  </div>
{% endif %}


{# â€”â€”â€” Flag de victoria (para JS) â€”â€”â€” #}
{% if won %}
  <script id="won-flag" data-champ="{{ target.name|escapejs }}"></script>
{% endif %}

{# â€”â€”â€” Formulario siempre presente, pero desactivado si won â€”â€”â€” #}
<form id="guess-form"
      action="{{ guess_url }}"
      method="post"
      class="bg-amber-100/90 backdrop-blur rounded-3xl p-6 border-4 border-yellow-800 shadow-lg w-full max-w-xl text-gray-900
             {% if won %}opacity-50 pointer-events-none{% endif %}" style="margin-bottom: 100px"
      novalidate>

  {% csrf_token %}
  <label for="guess" class="block font-semibold mb-2">Â¿QuiÃ©n crees que es?</label>

  {% if guess_error %}
    <p class="text-red-700 font-bold mb-2">Ese personaje no existe o ya fue usado.</p>
  {% endif %}

  <div class="relative">
    <input  type="text" name="guess" id="guess" autofocus
            class="w-full p-2 rounded-t border border-yellow-400 bg-white focus:outline-none"
            placeholder="Escribe un nombre"
            autocomplete="off"
            required
            data-names="{{ remaining_names_json|escape }}"
            {% if won %}disabled{% endif %}>
    <ul id="suggestions" role="listbox"
        class="hidden w-full absolute left-0 top-full bg-white text-gray-900 rounded-b-xl
               border-x border-b border-yellow-400 max-h-56 overflow-y-auto z-50"></ul>
  </div>

  <button type="submit"
          class="mt-4 bg-yellow-700 hover:bg-yellow-800 text-white px-4 py-2 rounded-full transition w-full shadow"
          {% if won %}disabled{% endif %}>
    Probar
  </button>
</form>

{# ---------- Cabecera de atributos ---------- #}
{% if game.attributes %}
  {# â€”â€”â€” CABECERA + INTENTOS CON SCROLL LATERAL â€”â€”â€” #}
<div class="attempts-scroll-wrapper">
  <div id="attempts-header"
       {% if attempts %}class="header-grid"{% else %}class="header-grid" style="display:none;"{% endif %}
       data-cols="{{ game.attributes|length|add:'1' }}">
    <div class="header-cell">Personaje</div>
    {% for attr in game.attributes %}
      <div class="header-cell">{{ attr|title }}</div>
    {% endfor %}
  </div>

  <div id="attempts-container"></div>
</div>

{# â€”â€”â€” HISTORIAL JSON â€”â€”â€” #}
{% if attempts %}
  {{ attempts|json_script:"initial-attempts" }}
{% endif %}
{% endif %}


{# â€”â€”â€” Personaje de ayer â€”â€”â€” #}
{% if yesterday_target_name %}
  <div class="mt-6 mx-auto max-w-xl bg-black/60 text-white border-2 border-yellow-600 rounded-xl px-4 py-3 shadow-lg backdrop-blur">
    <p class="text-lg text-yellow-200 font-semibold text-center"
       style="font-family: var(--font-lol); text-shadow: 1px 1px #000;">
      ğŸ• El personaje de ayer fue: <span class="text-white">{{ yesterday_target_name }}</span>
    </p>
  </div>
{% endif %}

{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js" defer></script>
  <script src="{% static 'js/guess-autocomplete.js' %}" defer></script>
  <script src="{% static 'js/attempts-live.js' %}" defer></script>


{% if is_challenge %}
<form id="challenge-report-form" method="POST" action="{% url 'play_challenge' challenge_id %}">
  {% csrf_token %}
  <input type="hidden" name="attempts" id="challenge-attempts-input">
</form>
{% endif %}

{% endblock %}
